### Challenge 1: GitOps and AKS
Objective: Understand GitOps.

Goals:
- Deploy a Bedrock single key-vault cluster
- Deploy the Azure voting app resource manifest

Suggested reading:
- [Why GitOps?](https://github.com/microsoft/bedrock/blob/docs_spk/docs/why-gitops.md)
- [GitOps - Operations by Pull Request](https://www.weave.works/blog/gitops-operations-by-pull-request)
- [SPK](https://github.com/CatalystCode/spk/tree/390acbc8ab3ed20082bd50657eab16402e37144c)
- [A first Workload with Bedrock](https://github.com/microsoft/bedrock/tree/docs_spk/docs/firstWorkload)

## Steps
### Required resources
To deploy a single key-vault cluster using `spk` you will need the following:
1. Service principal
2. Storage account
3. Storage account access key
4. Resource group
5. Deploy Key (for the manifest repo)
6. Node Key (for the cluster)

The [scripts/infra-setup.sh](../scripts/infra-setup.sh) creates this for you.

To run:
```
cd scripts
bash infra-setup.sh
```

This creates two files that contain the information of the required resources:
- service-principal.json
- infra-values.txt

The infra-values.txt will look similar to this:
```
Resource group: <username>-spkinfra-rg
Storage account: <username>spkinfrasa
Storage account key: <key_value>
Container: infracontainer

Deploy key path: /me/cluster-deployment/keys/gitops-ssh-key
Deploy public key: /me/cluster-deployment/keys/gitops-ssh-key.pub

Node key path: /me/cluster-deployment/keys/node-ssh-key
Node public key: /me/cluster-deployment/keys/node-ssh-key.pub

```

### Deploy cluster (work in progres...)

#### Add Deploy Key to manifest repo
The deploy key generated in [Required resources](#required-resources) needs to be added to the manifest repo `voting-app-manifest`.

Get the deploy public key file from the infra-values.txt file. It should be under `Deploy public key`.

Get the value of the key:
```
cat /me/cluster-deployment/keys/gitops-ssh-key.pub
```

Add the key value to Azure DevOps, follow [these steps](https://docs.microsoft.com/en-us/azure/devops/repos/git/use-ssh-keys-to-authenticate?view=azure-devops&tabs=current-page#step-2--add-the-public-key-to-azure-devops-servicestfs).

### Scaffold Common Infra
First we will scaffold the azure-common-infra environment. The azure-common-infra environment is a production ready template to setup common permanent elements of your infrastructure like vnets, keyvault, and a common resource group for them. The azure-common-infra environment is a dependency environment for other environments like the azure-single-keyvault.

```
$ mkdir ~/cluster-deployment
$ cd ~/cluster-deployment
$ spk infra scaffold --name cluster --source https://github.com/microsoft/bedrock --version master --template cluster/environments/azure-common-infra
```

This fetches the specified deployment template, creates a cluster directory, and a definition.yaml. This is the infrastructure definition.

Sample definition.yaml:
```
name: cluster
source: 'https://github.com/microsoft/bedrock'
template: cluster/environments/azure-common-infra
version: master
backend:
  storage_account_name: <storage account name>
  access_key: <storage access key>
  container_name: <storage account container>
  key: tfstate-common-infra
variables:
  address_space: <insert value>
  keyvault_name: <insert value>
  global_resource_group_name: <insert value>
  service_principal_id: <insert value>
  subnet_name: <insert value>
  subnet_prefix: <insert value>
  vnet_name: <insert value>
```

#### Fill out definition.yaml
Use the values in infra-values.txt ([Required resources](#required-resources)) to fill out the following:
- storage_account_name
- access_key
- container_name

From service-principal.json, which was previously generated by ([Required resources](#required-resources)), fill out:
- global_resource_group_name

Delete these entries from definition.yaml:
- service_principal_id
- tenant_id

Fill out the remaining values:

Use the `global_resource_group_name` value from the previous step.
```
vnet_name = "<global_resource_group_name>-spk-vnet"

subnet_name = "<global_resource_group_name>-spk-mysubnet"

subnet_prefix = "10.39.0.0/24"

address_space = "10.39.0.0/16"

keyvault_name = "<global_resource_group_name>-spk-keyvault"
```

#### Setup environment variables
Setup the following environment variables:
```
export ARM_SUBSCRIPTION_ID="(subscription id from infra-values.txt)"
export ARM_TENANT_ID="(tenant from service-principal.json)"
export ARM_CLIENT_SECRET="(password from service-principal.json)"
export ARM_CLIENT_ID="(appId from service-principal.json)"
```

#### Deploy common infra
```
cd ~/cluster-deployment/cluster
spk infra generate
```

This will generate the necessary files to deploy the infrastructure. The files should be available at `~/cluster-deployment/generated-cluster`.

Run terraform init:
```
cd ~/cluster-deployment/generated-cluster
terraform init
```

Verify with terraform plan:
```
terraform plan -var-file=spk.tfvars
```

Create the infrastructure components:
```
terraform apply -var-file=spk.tfvars
```

#### Deploy an AKS cluster
After the azure common infrastructure is deployed, we will deploy a cluster.

- cluster_name: Choose a cluster name, for example myname-cluster
- dns_prefix: Use the value you chose for cluster_name

- Deploy a kubernetes single key-vault cluster with flux via `spk`
- Clone the `voting-manifest` repo that was created in the previous challenge
- Push the [azure-vote.yaml](../azure-vote.yaml)(resource manifest file) for the voting app in the `voting-manifest` repository.

